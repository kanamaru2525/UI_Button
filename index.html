<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Document</title>
    <style>
      html {
        touch-action: manipulation;
        overflow: hidden;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f9f9f9;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80vh;
      }
      .display {
        font-size: 24px;
        padding: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 1em;
        margin-bottom: 1em;
        text-align: center;
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3列 */
        grid-template-rows: repeat(4, auto); /* 4行 */
        /* gap: 10px; */
        gap: var(--grid-container-gap); /* ギャップを変数で指定 */
        width: 95vw; /* スマホで横幅をほぼ埋める */
        max-width: 480px; /* 最大幅を指定 */
        margin: auto;
      }

      .grid-item {
        font-size: 2rem;
        padding: 15px;
        text-align: center;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        /* border-radius: 90px; */
        border-radius: var(--grid-item-border-radius);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s, transform 0.2s;
        aspect-ratio: 1;
        width: 100%;
      }

      .grid-item:active {
        background-color: #0056b3;
        transform: scale(0.95); /* クリック時に少し縮む */
      }

      .item-0 {
        grid-column: 2; /* 中央に配置 */
      }

      /* 各種CSSスタイル */
      .style1 {
        --grid-item-border-radius: 90px;
        --grid-container-gap: 20px;
      }
      .style2 {
        --grid-item-border-radius: 90px;
        --grid-container-gap: 50px;
      }
      .style3 {
        --grid-item-border-radius: 90px;
        --grid-container-gap: 90px;
      }
      .style4 {
        --grid-item-border-radius: 8px;
        --grid-container-gap: 90px;
      }
      .style5 {
        --grid-item-border-radius: 8px;
        --grid-container-gap: 90px;
      }
      .style6 {
        --grid-item-border-radius: 8px;
        --grid-container-gap: 90px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        font-size: larger;
      }
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 1);
        z-index: 999;
      }
      .close-btn {
        margin-top: 10px;
        padding: 5px 10px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      .close-btn:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="calculator">
      <div class="display" id="display">0</div>
      <div class="grid-container">
        <button class="grid-item">1</button>
        <button class="grid-item">2</button>
        <button class="grid-item">3</button>
        <button class="grid-item">4</button>
        <button class="grid-item">5</button>
        <button class="grid-item">6</button>
        <button class="grid-item">7</button>
        <button class="grid-item">8</button>
        <button class="grid-item">9</button>
        <button class="grid-item item-0">0</button>
      </div>
    </div>

    <div class="modal-overlay" id="initialModalOverlay"></div>
    <div class="modal" id="initialModal">
      <p id="initialModalMessage"></p>
    </div>

    <div class="modal-overlay" id="resultModalOverlay"></div>
    <div class="modal" id="resultModal">
      <p id="resultModalMessage"></p>
      <button class="close-btn" id="retryButton">次へ</button>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        try {
          // CSSクラスのリスト
          const cssClasses = ["style1", "style2", "style3", "style4", "style5", "style6"];
          const MaxNum = 42; // 最大試行回数
          const allocation = MaxNum / cssClasses.length; // 各CSSが使用される回数
          let attempts = 0; // 現在の試行回数
          let results = []; // 結果を保存
    
          // CSSをランダムに割り振る配列
          const cssSequence = [];
          while (cssSequence.length < MaxNum) {
            cssClasses.forEach((css) => {
              if (cssSequence.filter((c) => c === css).length < allocation) {
                cssSequence.push(css);
              }
            });
          }
          cssSequence.sort(() => Math.random() - 0.5);
    
          // DOM要素の取得
          const display = document.getElementById("display");
          const buttons = document.querySelectorAll(".grid-item");
          const gridContainer = document.querySelector(".grid-container");
          const initialModalOverlay = document.getElementById("initialModalOverlay");
          const initialModal = document.getElementById("initialModal");
          const initialModalMessage = document.getElementById("initialModalMessage");
          const resultModalOverlay = document.getElementById("resultModalOverlay");
          const resultModal = document.getElementById("resultModal");
          const resultModalMessage = document.getElementById("resultModalMessage");
          const retryButton = document.getElementById("retryButton");
    
          if (
            !display ||
            !buttons ||
            !gridContainer ||
            !initialModalOverlay ||
            !initialModal ||
            !initialModalMessage ||
            !resultModalOverlay ||
            !resultModal ||
            !resultModalMessage ||
            !retryButton
          ) {
            throw new Error("必要なDOM要素が見つかりません");
          }
    
          // ランダムな5桁の数字を生成
          const generateRandomFiveDigitNumber = () => {
            return Math.floor(10000 + Math.random() * 90000);
          };
    
          // 初期モーダルを表示する関数
          const showInitialModal = (message) => {
            try {
              initialModalMessage.textContent = message;
              initialModalOverlay.style.display = "block";
              initialModal.style.display = "block";
    
              setTimeout(() => {
                initialModalOverlay.style.display = "none";
                initialModal.style.display = "none";
              }, 3000);
            } catch (error) {
              console.error("初期モーダルの表示中にエラーが発生しました:", error);
            }
          };
    
          // 結果モーダルを表示する関数
          const showResultModal = (message) => {
            try {
              resultModalMessage.textContent = message;
              resultModalOverlay.style.display = "block";
              resultModal.style.display = "block";
            } catch (error) {
              console.error("結果モーダルの表示中にエラーが発生しました:", error);
            }
          };
    
          // CSS切り替えと挑戦開始
          const challengeCSS = () => {
            try {
              const selectedCSS = cssSequence[attempts]; // 現在のCSS
              const randomFiveDigitNumber = generateRandomFiveDigitNumber(); // ランダムな5桁の数字
              let userInput = ""; // ユーザー入力
              let startTime = null; // 開始時間
              let incorrectAttempts = 0; // 誤入力の回数
    
              gridContainer.className = "grid-container " + selectedCSS; // CSSを変更
              showInitialModal(`${randomFiveDigitNumber}`);
    
              const targetSequence = randomFiveDigitNumber.toString().split("");
    
              // ボタンイベントの登録
              buttons.forEach((button) => {
                button.addEventListener("click", () => {
                  try {
                    const value = button.textContent;
    
                    if (startTime === null) {
                      startTime = new Date();
                    }
    
                    const nextExpectedValue = targetSequence[userInput.length];
                    if (value === nextExpectedValue) {
                      userInput += value;
                      display.textContent = userInput;
                    } else {
                      incorrectAttempts++;
                      userInput = ""; // リセット
                      display.textContent = "0"; // リセット
                    }
    
                    if (userInput.length === 5) {
                      if (userInput === randomFiveDigitNumber.toString()) {
                        const endTime = new Date();
                        const timeTaken = (endTime - startTime) / 1000;
    
                        results.push({
                          css: selectedCSS,
                          timeTaken,
                          incorrectAttempts,
                          date: new Date().toISOString(),
                        });
    
                        attempts++;
                        if (attempts < MaxNum) {
                          showResultModal(`attempts ${attempts}回目`);
                        } else {
                          const fileName = `results_${new Date().toISOString()}.json`;
                          const blob = new Blob([JSON.stringify(results, null, 2)], {
                            type: "application/json",
                          });
                          const link = document.createElement("a");
                          link.href = URL.createObjectURL(blob);
                          link.download = fileName;
                          link.click();
                        }
    
                        userInput = ""; // 入力リセット
                      } else {
                        alert("入力が間違っています。");
                        userInput = ""; // 入力リセット
                        display.textContent = "0"; // 表示リセット
                      }
                    }
                  } catch (error) {
                    console.error("ボタンクリック中にエラーが発生しました:", error);
                  }
                });
              });
    
              // リトライボタンの動作
              retryButton.addEventListener("click", () => {
                try {
                  resultModalOverlay.style.display = "none";
                  resultModal.style.display = "none";
                  userInput = "";
                  display.textContent = "0";
                  challengeCSS(); // 再挑戦
                } catch (error) {
                  console.error("リトライ中にエラーが発生しました:", error);
                }
              });
            } catch (error) {
              console.error("CSS切り替え中にエラーが発生しました:", error);
            }
          };
    
          challengeCSS(); // 初回挑戦を開始
        } catch (error) {
          console.error("初期化中にエラーが発生しました:", error);
        }
      });
    </script>
    
  </body>
</html>
